#! /usr/bin/env node

// require('babel-core/register');
// require('babel-polyfill');
const inquirer = require('inquirer');
const path = require('path');
const chalk = require('chalk');
const fs = require('fs');
const child_process = require('child_process');
const config = require('./config');
const files = require('./getfiles');
const qs = require('./questions');
const infoFn = require('./infoFn');

function execSh(item, cwd) {
  return new Promise((resolve, reject) => {
    console.log((`\n${chalk.cyan('executing:')} ${chalk.red(item.command)}`));
    ls = child_process.exec(item.command, { cwd });
    ls.stdout.on('data', function(data) {
      console.log(data);
      item.errfn && item.errfn(data);
    });
    ls.stderr.on('data', function(data) {
      console.log(data);
      item.errfn && item.errfn(data);
    });
    ls.on('close', () => {
      resolve();
    });
  });
}

var execCommand = async function (info) {
  for (var j = 0; j < info.length; j += 1) {
    const content = info[j];
    await (function () {
      return new Promise((resolve) => {
        j !== 0 && console.log(`===================${chalk.green('end')}=====================\n\n\n`);
        console.log(`${chalk.green(`>>>start to execute the commands for ${chalk.yellow(content.name)}`)}\n`);
        console.log(`===================${chalk.green('start')}===================`);
        const commands = config.commands(info[j]);
        (async function(){
          for (var i = 0; i < commands.length; i += 1) {
            if (content.isError) {
              break;
            }
            await execSh(commands[i], path.resolve(process.cwd(), content.name));
          }
          resolve()
          // console.log(chalk.green(`publish "${info[j].type}/${info[j].version}" successfully!`));
        })();
      })
    })();
  }
  // 统计发布信息
  infoFn.statInfo(info);
}

const info = [];
const defaultData = {}; // 默认选项
function recursiveQuestion(content, index) {
  if (content.files.length <= index) {
    console.log(info);
    // execCommand(info);
    return;
  }
  const name = content.files[index];
  console.log('===========================================\n');
  console.log(`${chalk.green(`Please select follow Options for 「${chalk.yellow(name)}」project`)}\n`);
  console.log('===========================================');
  inquirer.prompt(qs.questions(name, defaultData, content.isCurrentDir)).then(subContent => {
    defaultData.type = subContent.type; // 记忆type类型为默认值
    defaultData.isBuild = subContent.isBuild; // 记忆isBuild值为默认值
    info.push(Object.assign({}, { name }, subContent));
    recursiveQuestion(content, index + 1)
  });
}
function pub () {
  // if (qs.fileChoiceQuestion.type) {
  //   inquirer.prompt(qs.fileChoiceQuestion).then((content) => {
  //     recursiveQuestion(content, 0);
  //   });
  // } else {
  //   const content = {
  //     files: [path.basename(process.cwd())],
  //     isCurrentDir: true
  //   };
  //   recursiveQuestion(content, 0);
  // }

  const a = [ { name: 'cg-ant-competitive-evaluation',
    type: 'daily',
    version: '1.99.1' },
  { name: 'cg-ant-purchaser-home',
    type: 'daily',
    version: '1.0.0' } ];
    execCommand(a);
}

const args = process.argv.slice(2);
if (args.length) {
  if (args.length === 1 && (args[0] === '-V' || args[0] === '--version')) {
    console.log(require('../package.json').version);
  } else {
    infoFn.helpInfo();
  }
} else {
  pub();
}

